<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”êµ¬ê°„ ìë™ íƒìƒ‰ í”Œë«í¼</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,'Malgun Gothic',sans-serif;background:#0a0a0f;color:#e0e0e0;overflow:hidden;height:100vh;display:flex;flex-direction:column;}

/* ìƒë‹¨ */
.top{background:#0f0f16;padding:7px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(240,180,41,.3);flex-shrink:0;z-index:2000;}
.top h1{font-size:14px;font-weight:900;color:#f0b429;}
.top .sub{font-size:10px;color:#666;}
.top .badges{margin-left:auto;display:flex;gap:5px;}
.badge{padding:2px 7px;border-radius:20px;font-size:9px;font-weight:700;}
.badge-green{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.4);color:#22c55e;}
.badge-red{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.4);color:#ef4444;}

.main{display:flex;flex:1;overflow:hidden;}

/* ì¢Œì¸¡ íŒ¨ë„ */
.panel{width:270px;flex-shrink:0;background:rgba(12,12,18,.98);border-right:1px solid rgba(255,255,255,.06);overflow-y:auto;padding:10px;z-index:1500;font-size:10px;}
.panel::-webkit-scrollbar{width:3px;}
.panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px;}
.sec{margin-bottom:10px;}
.sec-t{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:5px;letter-spacing:.3px;}

.ltog{display:flex;align-items:center;gap:5px;padding:5px 7px;margin-bottom:2px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:5px;cursor:pointer;transition:all .15s;}
.ltog:hover{background:rgba(255,255,255,.06);}
.ltog.on{border-color:var(--c);background:var(--bg);}
.ltog .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .15s;}
.ltog .nm{font-weight:600;flex:1;font-size:10px;}
.ltog .ct{font-weight:900;color:var(--c);font-size:10px;}

.stat-card{padding:8px;margin-bottom:6px;background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.2);border-radius:8px;text-align:center;}
.stat-card .big{font-size:28px;font-weight:900;color:#f0b429;}
.stat-card .lb{font-size:9px;color:#666;}

.tgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;margin-bottom:6px;}
.tg{padding:4px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:4px;text-align:center;}
.tg .tn{font-size:10px;font-weight:700;}
.tg .tv{font-size:11px;font-weight:900;color:#22c55e;margin-top:2px;}

.api-st{margin-bottom:10px;}
.api-row{display:flex;align-items:center;gap:5px;padding:3px 6px;font-size:9px;}
.api-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.api-nm{flex:1;font-weight:600;}
.api-status{font-size:8px;}

.sitem{display:flex;align-items:center;gap:5px;padding:4px 6px;margin-bottom:2px;background:rgba(255,255,255,.03);border:1px solid transparent;border-radius:4px;cursor:pointer;transition:all .12s;}
.sitem:hover{background:rgba(240,180,41,.1);}
.sitem.active{background:rgba(240,180,41,.15);border-color:rgba(240,180,41,.3);}
.sitem .rk{width:16px;height:16px;border-radius:50%;background:#f0b429;color:#000;font-size:8px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sitem .sn{flex:1;font-weight:600;font-size:10px;}
.sitem .st{padding:1px 3px;border-radius:3px;font-size:8px;font-weight:700;}
.sitem .sc{font-weight:900;color:#f0b429;font-size:9px;}

/* ì§€ë„ */
.map-wrap{flex:1;position:relative;z-index:1;}
#map{width:100%;height:100%;z-index:1;}

/* Leaflet íŒì—… ì»¤ìŠ¤í…€ */
.leaflet-popup-content-wrapper{background:rgba(15,15,25,.96)!important;color:#e0e0e0!important;border:1px solid rgba(240,180,41,.35)!important;border-radius:10px!important;box-shadow:0 8px 32px rgba(0,0,0,.6)!important;}
.leaflet-popup-tip{background:rgba(15,15,25,.96)!important;}
.leaflet-popup-content{margin:10px 14px!important;font-family:-apple-system,'Malgun Gothic',sans-serif!important;}

.pp-title{font-size:14px;font-weight:900;color:#f0b429;margin-bottom:8px;}
.pp-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:10px;margin-bottom:8px;}
.pp-row{display:flex;justify-content:space-between;}
.pp-row .k{color:#666;}
.pp-row .v{font-weight:700;}
.pp-desc{font-size:9px;color:#888;line-height:1.4;margin-bottom:10px;}
.pp-btn{width:100%;padding:10px;background:linear-gradient(135deg,#f0b429,#e09000);border:none;border-radius:8px;color:#000;font-weight:900;font-size:11px;cursor:pointer;text-align:center;}
.pp-btn:hover{filter:brightness(1.1);}
.pp-btn-sub{font-size:8px;color:#666;text-align:center;margin-top:3px;}

/* AI íŒ¨ë„ */
.ai-panel{position:absolute;top:10px;right:10px;width:330px;max-height:calc(100% - 20px);overflow-y:auto;background:rgba(12,12,18,.97);border:1px solid rgba(240,180,41,.4);border-radius:12px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.7);z-index:1500;display:none;}
.ai-panel.show{display:block;}
.ai-panel::-webkit-scrollbar{width:3px;}
.ai-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px;}

.ai-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.ai-header h3{font-size:13px;font-weight:900;color:#f0b429;}
.ai-close{cursor:pointer;color:#666;font-size:16px;}
.ai-close:hover{color:#fff;}

.ai-loading{text-align:center;padding:30px;}
.ai-loading .spin{font-size:28px;display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.ai-loading .msg{font-size:11px;color:#f0b429;font-weight:700;margin-top:8px;}
.ai-loading .sub{font-size:9px;color:#666;margin-top:3px;}

.ai-verdict{padding:12px;background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);border-radius:8px;margin-bottom:10px;text-align:center;}
.ai-verdict .label{font-size:9px;color:#888;margin-bottom:2px;}
.ai-verdict .rec{font-size:20px;font-weight:900;}
.ai-verdict .stats{display:flex;justify-content:center;gap:14px;margin-top:8px;}
.ai-verdict .stat{text-align:center;}
.ai-verdict .stat .sl{font-size:8px;color:#888;}
.ai-verdict .stat .sv{font-size:15px;font-weight:900;}

.ai-factors{margin-bottom:10px;}
.ai-factors .title{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:4px;}
.ai-factor{font-size:9px;padding:3px 8px;margin-bottom:2px;background:rgba(239,68,68,.08);border-left:2px solid #ef4444;border-radius:0 4px 4px 0;color:#ccc;}

.ai-n2b{padding:10px;background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.15);border-radius:8px;margin-bottom:10px;}
.ai-n2b .title{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:6px;}
.ai-n2b .line{font-size:10px;margin-bottom:4px;line-height:1.4;}
.ai-n2b .ln{color:#ef4444;font-weight:700;}
.ai-n2b .lb{color:#f0b429;font-weight:700;}

.ai-cost{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.ai-cost-card{padding:8px;border-radius:6px;text-align:center;}
.ai-cost-card .cl{font-size:8px;color:#888;}
.ai-cost-card .cv{font-size:16px;font-weight:900;}
.ai-cost-card .ct{font-size:9px;font-weight:600;margin-top:2px;line-height:1.3;}

.ai-detail{padding:8px;background:rgba(255,255,255,.03);border-radius:6px;font-size:9px;color:#aaa;line-height:1.5;margin-bottom:10px;}
.ai-detail .dt{font-size:9px;font-weight:700;color:#888;margin-bottom:3px;}

.ai-retry{width:100%;padding:8px;background:rgba(240,180,41,.12);border:1px solid rgba(240,180,41,.3);border-radius:6px;color:#f0b429;font-weight:700;font-size:10px;cursor:pointer;}
.ai-retry:hover{background:rgba(240,180,41,.2);}

.ai-error{padding:12px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:10px;color:#ef4444;}

/* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
.custom-marker{border-radius:50%;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;transition:transform .2s;}
.custom-marker:hover{transform:scale(1.2);}

/* N2B ë°•ìŠ¤ */
.n2b-box{padding:8px;background:rgba(240,180,41,.04);border:1px solid rgba(240,180,41,.12);border-radius:6px;font-size:9px;line-height:1.5;margin-top:6px;}
.n2b-box .nr{color:#ef4444;font-weight:700;}
.n2b-box .br{color:#f0b429;font-weight:700;}

/* ëª¨ë°”ì¼ */
@media(max-width:768px){
    .panel{width:220px;padding:8px;}
    .ai-panel{width:280px;right:5px;top:5px;}
}
@media(max-width:480px){
    .panel{display:none;}
    .ai-panel{width:calc(100% - 20px);left:10px;right:10px;}
}
</style>
</head>
<body>

<div class="top">
    <span style="font-size:18px;">ğŸ›£ï¸</span>
    <div>
        <h1>ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”êµ¬ê°„ ìë™ íƒìƒ‰ í”Œë«í¼</h1>
        <div class="sub">ì‹¤ì œ ë„ë¡œ ì§€ë„ + Claude AI ì‹¤ì‹œê°„ ë¶„ì„ + ê³µê³µ API ì—°ë™</div>
    </div>
    <div class="badges">
        <div class="badge badge-green">AI ì—°ê²°ë¨</div>
        <div class="badge badge-red">PROTOTYPE v1.0</div>
    </div>
</div>

<div class="main">
    <!-- ì¢Œì¸¡ íŒ¨ë„ -->
    <div class="panel" id="panel">
        <div class="sec">
            <div class="sec-t">ğŸ“Š í¬ì¥ ìœ í˜• ë ˆì´ì–´</div>
            <div class="ltog on" style="--c:#ef4444;--bg:rgba(239,68,68,.06);" data-t="drain" onclick="togLayer(this)">
                <div class="dot" style="background:#ef4444;"></div>
                <div class="nm">ğŸ›£ï¸ ë°°ìˆ˜ì„± (ê²½ì‚¬+í­ìš°+ì‚¬ê³ )</div>
                <div class="ct">9</div>
            </div>
            <div class="ltog on" style="--c:#a855f7;--bg:rgba(168,85,247,.06);" data-t="quiet" onclick="togLayer(this)">
                <div class="dot" style="background:#a855f7;"></div>
                <div class="nm">ğŸ”‡ ì €ì†ŒìŒ (ì£¼ê±°+êµí†µëŸ‰)</div>
                <div class="ct">8</div>
            </div>
            <div class="ltog on" style="--c:#06b6d4;--bg:rgba(6,182,212,.06);" data-t="perm" onclick="togLayer(this)">
                <div class="dot" style="background:#06b6d4;"></div>
                <div class="nm">ğŸ’§ íˆ¬ìˆ˜ì„± (ì¹¨ìˆ˜+ë¶ˆíˆ¬ìˆ˜ë©´)</div>
                <div class="ct">6</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-t">ğŸ¯ ì¢…í•© ë¶„ì„</div>
            <div class="stat-card">
                <div class="big">23</div>
                <div class="lb">ê¸°ëŠ¥ì„± í¬ì¥ ì¶”ì²œ êµ¬ê°„</div>
            </div>
            <div class="tgrid">
                <div class="tg"><div class="tn" style="color:#ef4444;">ë°°ìˆ˜ì„±</div><div class="tv">9ê³³</div></div>
                <div class="tg"><div class="tn" style="color:#a855f7;">ì €ì†ŒìŒ</div><div class="tv">8ê³³</div></div>
                <div class="tg"><div class="tn" style="color:#06b6d4;">íˆ¬ìˆ˜ì„±</div><div class="tv">6ê³³</div></div>
            </div>
        </div>

        <div class="sec api-st">
            <div class="sec-t">ğŸ“¡ API ì—°ë™ ìƒíƒœ</div>
            <div class="api-row"><div class="api-dot" style="background:#22c55e;"></div><div class="api-nm">Claude AI ë¶„ì„</div><div class="api-status" style="color:#22c55e;">ì‹¤ì‹œê°„</div></div>
            <div class="api-row"><div class="api-dot" style="background:#22c55e;"></div><div class="api-nm">OpenStreetMap ì§€ë„</div><div class="api-status" style="color:#22c55e;">ì—°ê²°ë¨</div></div>
            <div class="api-row"><div class="api-dot" style="background:#f59e0b;"></div><div class="api-nm">ê¸°ìƒì²­ ASOS</div><div class="api-status" style="color:#666;">ìƒ˜í”Œ</div></div>
            <div class="api-row"><div class="api-dot" style="background:#f59e0b;"></div><div class="api-nm">TAAS ì‚¬ê³ ì´ë ¥</div><div class="api-status" style="color:#666;">ìƒ˜í”Œ</div></div>
            <div class="api-row"><div class="api-dot" style="background:#f59e0b;"></div><div class="api-nm">êµ­í† ì •ë³´ DEM</div><div class="api-status" style="color:#666;">ìƒ˜í”Œ</div></div>
            <div class="api-row"><div class="api-dot" style="background:#666;"></div><div class="api-nm">ITS CCTV</div><div class="api-status" style="color:#666;">ë¯¸ì—°ê²°</div></div>
        </div>

        <div class="sec">
            <div class="sec-t">ğŸ† ìš°ì„ ìˆœìœ„ TOP 10</div>
            <div id="spotList"></div>
        </div>

        <div class="sec">
            <div class="n2b-box">
                <div class="nr">N: "ì„œìš¸ì‹œ ì „ì²´ ë„ë¡œì— ê¸°ëŠ¥ì„± í¬ì¥"</div>
                <div class="br">B: ì „ë¶€ëŠ” ì•„ë‹ˆì§€ë§Œ</div>
                <div class="br">B: ê²½ì‚¬3%+âˆ©í­ìš°âˆ©ì‚¬ê³  â†’ <b style="color:#f0b429;">23ê³³</b>ì—” í•„ìš”!</div>
                <div style="color:#555;margin-top:3px;">â†’ ì „ì²´ 2.3%ë§Œ â†’ ì‚¬ê³  30%â†“<br>23ê³³Ã—2kmÃ—3ì²œë§Œ = <b style="color:#f0b429;">ì•½ 138ì–µì›</b></div>
            </div>
        </div>
    </div>

    <!-- ì§€ë„ -->
    <div class="map-wrap">
        <div id="map"></div>
        <!-- AI ë¶„ì„ íŒ¨ë„ -->
        <div class="ai-panel" id="aiPanel">
            <div class="ai-header">
                <h3>ğŸ¤– AI ì¢…í•© ë¶„ì„</h3>
                <span class="ai-close" onclick="closeAI()">âœ•</span>
            </div>
            <div id="aiSpotName" style="font-size:11px;font-weight:700;color:#ccc;margin-bottom:8px;"></div>
            <div id="aiContent"></div>
        </div>
    </div>
</div>

<script>
// ===== ë°ì´í„° =====
var SPOTS = [
    {id:1,n:'ë‚¨ì‚° ìˆœí™˜ë¡œ',la:37.5512,lo:126.9882,t:'drain',sl:6.2,rn:42,ac:8,sc:95,ds:'ê¸‰ê²½ì‚¬ 6.2% + ì—° 42íšŒ í­ìš° + ìš°ì²œì‚¬ê³  8ê±´/ë…„',tr:35000,im:60,fl:1,cm:3},
    {id:2,n:'ê°•ë‚¨ì—­ ì¼ëŒ€',la:37.4979,lo:127.0276,t:'perm',sl:1.2,rn:38,ac:3,sc:94,ds:'ë¶ˆíˆ¬ìˆ˜ë©´ 92% + ì¹¨ìˆ˜ 5íšŒ/10ë…„',tr:72000,im:92,fl:5,cm:8},
    {id:3,n:'ì˜¬ë¦¼í”½ëŒ€ë¡œ ì ì‹¤',la:37.518,lo:127.075,t:'quiet',sl:0.8,rn:35,ac:4,sc:92,ds:'ì¼ 8.5ë§ŒëŒ€ + ì ì‹¤ì•„íŒŒíŠ¸ ì¸ì ‘',tr:85000,im:75,fl:2,cm:23},
    {id:4,n:'ë¶ì•…ìŠ¤ì¹´ì´ì›¨ì´',la:37.593,lo:126.967,t:'drain',sl:8.1,rn:38,ac:5,sc:91,ds:'ê¸‰ê²½ì‚¬ 8.1% + ì»¤ë¸Œ ì—°ì†',tr:12000,im:30,fl:0,cm:1},
    {id:5,n:'ì‹ ë¦¼ì—­ ì¼ëŒ€',la:37.484,lo:126.929,t:'perm',sl:2.1,rn:40,ac:4,sc:88,ds:'ê´€ì•…ì‚° ìœ ìˆ˜ + ì¹¨ìˆ˜ ë°˜ë³µ',tr:45000,im:85,fl:6,cm:5},
    {id:6,n:'ì¸ì™•ì‚°í„°ë„ ì§„ì…',la:37.581,lo:126.958,t:'drain',sl:5.4,rn:40,ac:6,sc:88,ds:'í„°ë„ ì§„ì¶œì… ê²½ì‚¬ + ë…¸ë©´ ì˜¨ë„ì°¨',tr:28000,im:45,fl:1,cm:2},
    {id:7,n:'ë‚´ë¶€ìˆœí™˜ ì •ë¦‰',la:37.605,lo:127.008,t:'quiet',sl:1.5,rn:33,ac:3,sc:87,ds:'ì£¼ê±°ë°€ì§‘ + ì•¼ê°„ í™”ë¬¼ì°¨ ì†ŒìŒ',tr:62000,im:70,fl:1,cm:18},
    {id:8,n:'ë™ì‘ëŒ€êµ ë‚¨ë‹¨ ë¨í”„',la:37.5050,lo:126.982,t:'drain',sl:4.8,rn:44,ac:7,sc:86,ds:'êµëŸ‰ ì ‘ì†ë¶€ ê²½ì‚¬ + ìˆ˜ë§‰',tr:55000,im:65,fl:2,cm:4},
    {id:9,n:'í•œë‚¨ëŒ€êµ ë¶ë‹¨ IC',la:37.534,lo:127.001,t:'drain',sl:4.2,rn:41,ac:9,sc:85,ds:'IC ë¨í”„ + í•©ë¥˜ë¶€ ì‚¬ê³  ë‹¤ë°œ',tr:68000,im:60,fl:1,cm:5},
    {id:10,n:'ì‚¬ë‹¹ì—­ ì¼ëŒ€',la:37.477,lo:126.982,t:'perm',sl:1.8,rn:39,ac:3,sc:85,ds:'ì €ì§€ëŒ€ + ë¶ˆíˆ¬ìˆ˜ë©´ 88%',tr:48000,im:88,fl:4,cm:6},
    {id:11,n:'ê°•ë³€ë¶ë¡œ ì„±ìˆ˜',la:37.542,lo:127.044,t:'quiet',sl:0.5,rn:34,ac:3,sc:84,ds:'ì„±ìˆ˜ë™ ì£¼ê±° ì¸ì ‘',tr:78000,im:72,fl:2,cm:15},
    {id:12,n:'ìš°ë©´ì‚°í„°ë„ ì ‘ì†ë¶€',la:37.475,lo:126.989,t:'drain',sl:4.5,rn:43,ac:6,sc:83,ds:'í„°ë„ + 2011 ì‚°ì‚¬íƒœ ì´ë ¥',tr:42000,im:55,fl:3,cm:3},
    {id:13,n:'ê´‘í™”ë¬¸ ì¼ëŒ€',la:37.572,lo:126.977,t:'perm',sl:0.5,rn:36,ac:2,sc:82,ds:'ë¶ˆíˆ¬ìˆ˜ë©´ 95% + ë³´í–‰ê³µê°„',tr:25000,im:95,fl:3,cm:4},
    {id:14,n:'ê°•ë‚¨ëŒ€ë¡œ ì—­ì‚¼',la:37.501,lo:127.037,t:'quiet',sl:1.0,rn:37,ac:4,sc:82,ds:'ìƒì—…+ì£¼ê±° ì•¼ê°„ì†ŒìŒ',tr:72000,im:80,fl:2,cm:20},
    {id:15,n:'ì–‘ì¬ëŒ€ë¡œ ì„œì´ˆ',la:37.483,lo:127.024,t:'quiet',sl:1.3,rn:36,ac:3,sc:81,ds:'ì„œì´ˆ ì£¼ê±° + ëŒ€í˜•ì°¨ëŸ‰',tr:68000,im:78,fl:1,cm:16},
    {id:16,n:'ì„±ì‚°ëŒ€êµ ë‚¨ë‹¨',la:37.548,lo:126.912,t:'drain',sl:3.8,rn:39,ac:5,sc:80,ds:'êµëŸ‰ ì ‘ì† ê²½ì‚¬',tr:52000,im:60,fl:1,cm:4},
    {id:17,n:'ë™ë¶€ê°„ì„  ì¥í•œí‰',la:37.562,lo:127.065,t:'quiet',sl:0.8,rn:32,ac:2,sc:79,ds:'ì•„íŒŒíŠ¸ + í„°ë„ ì†ŒìŒ',tr:55000,im:68,fl:1,cm:12},
    {id:18,n:'ê´€ì•…ì‚° ì„œìš¸ëŒ€ì…êµ¬',la:37.464,lo:126.952,t:'drain',sl:7.5,rn:36,ac:4,sc:78,ds:'ì‚°ì§€ 7.5% + ë°°ìˆ˜ ë¶ˆëŸ‰',tr:18000,im:40,fl:2,cm:2},
    {id:19,n:'ë„ë¦¼ì²œ ì£¼ë³€ ë³´ë„',la:37.495,lo:126.903,t:'perm',sl:0.8,rn:38,ac:1,sc:77,ds:'í•˜ì²œë³€ ì¹¨ìˆ˜ ì·¨ì•½',tr:15000,im:80,fl:4,cm:3},
    {id:20,n:'ì„œë¶€ê°„ì„  ì‹ ê¸¸',la:37.508,lo:126.915,t:'quiet',sl:0.6,rn:35,ac:3,sc:76,ds:'ì£¼ê±°ë°€ì§‘ + í™”ë¬¼ì°¨',tr:48000,im:72,fl:1,cm:14},
    {id:21,n:'ëŒ€ëª¨ì‚° ì§„ì…ë¡œ',la:37.482,lo:127.065,t:'drain',sl:5.8,rn:35,ac:3,sc:74,ds:'ì‚°ì§€ ê²½ì‚¬ + ë‚™ì—½',tr:8000,im:25,fl:0,cm:1},
    {id:22,n:'ë¶ë¶€ê°„ì„  ì›”ê³„',la:37.625,lo:127.052,t:'quiet',sl:0.7,rn:31,ac:2,sc:73,ds:'ì•„íŒŒíŠ¸ ì˜† ê³ ê°€ë„ë¡œ',tr:45000,im:65,fl:1,cm:11},
    {id:23,n:'ì¤‘ë‘ì²œ ë³€ ë³´ë„',la:37.575,lo:127.048,t:'perm',sl:0.4,rn:33,ac:1,sc:72,ds:'í•˜ì²œë³€ ì›”ë¥˜ ì´ë ¥',tr:12000,im:78,fl:3,cm:2}
];
SPOTS.sort(function(a,b){return b.sc-a.sc;});

var COL={drain:'#ef4444',quiet:'#a855f7',perm:'#06b6d4'};
var TN={drain:'ë°°ìˆ˜ì„±',quiet:'ì €ì†ŒìŒ',perm:'íˆ¬ìˆ˜ì„±'};
var TI={drain:'ğŸ›£ï¸',quiet:'ğŸ”‡',perm:'ğŸ’§'};
var vis={drain:true,quiet:true,perm:true};
var currentSpotIdx = null;

// ===== ì§€ë„ ì´ˆê¸°í™” =====
var map = L.map('map',{zoomControl:false}).setView([37.5665,126.978],12);
L.control.zoom({position:'topright'}).addTo(map);

// ë‹¤í¬ íƒ€ì¼ (CartoDB Dark)
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://openstreetmap.org">OSM</a> &copy; <a href="https://carto.com">CARTO</a>',
    subdomains:'abcd',maxZoom:19
}).addTo(map);

// ë§ˆì»¤ ë ˆì´ì–´ ê·¸ë£¹
var markerLayers = {drain:L.layerGroup().addTo(map),quiet:L.layerGroup().addTo(map),perm:L.layerGroup().addTo(map)};
var markers = [];

// ===== ë§ˆì»¤ ìƒì„± =====
SPOTS.forEach(function(s,i){
    var c = COL[s.t];
    var sz = s.sc>=90?30:s.sc>=80?24:18;
    var icon = L.divIcon({
        className:'',
        html:'<div class="custom-marker" style="width:'+sz+'px;height:'+sz+'px;background:'+c+';font-size:'+(sz>24?12:sz>18?10:8)+'px;">'+(i<10?(i+1):'')+'</div>',
        iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]
    });
    
    // íŒì—… ë‚´ìš©
    var popupHTML = '<div class="pp-title">'+TI[s.t]+' '+s.n+'</div>';
    popupHTML += '<div class="pp-grid">';
    popupHTML += '<div class="pp-row"><span class="k">ì¶”ì²œí¬ì¥</span><span class="v" style="color:'+c+'">'+TN[s.t]+'</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ìœ„í—˜ì ìˆ˜</span><span class="v" style="color:#f0b429">'+s.sc+'/100</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ê²½ì‚¬ë„</span><span class="v">'+s.sl+'%</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ì—°í­ìš°</span><span class="v">'+s.rn+'íšŒ</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ìš°ì²œì‚¬ê³ </span><span class="v" style="color:#ef4444">'+s.ac+'ê±´/ë…„</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">êµí†µëŸ‰</span><span class="v">'+(s.tr/10000).toFixed(1)+'ë§ŒëŒ€</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ë¶ˆíˆ¬ìˆ˜ë©´</span><span class="v">'+s.im+'%</span></div>';
    popupHTML += '<div class="pp-row"><span class="k">ì¹¨ìˆ˜ì´ë ¥</span><span class="v">'+s.fl+'íšŒ/10ë…„</span></div>';
    popupHTML += '</div>';
    popupHTML += '<div class="pp-desc">'+s.ds+'</div>';
    popupHTML += '<button class="pp-btn" onclick="analyzeSpot('+i+')">ğŸ¤– Claude AI ì¢…í•© ë¶„ì„ ì‹¤í–‰</button>';
    popupHTML += '<div class="pp-btn-sub">ì‹¤ì‹œê°„ API â†’ N2B í”„ë ˆì„ì›Œí¬ ì ìš©</div>';
    
    var marker = L.marker([s.la,s.lo],{icon:icon}).bindPopup(popupHTML,{maxWidth:260,minWidth:220});
    
    // ì˜í–¥ ë°˜ê²½ ì›
    var radius = s.sc>=90?400:s.sc>=80?300:200;
    var circle = L.circle([s.la,s.lo],{radius:radius,color:c,fillColor:c,fillOpacity:.06,weight:1,opacity:.2});
    
    markerLayers[s.t].addLayer(marker);
    markerLayers[s.t].addLayer(circle);
    markers.push({marker:marker,circle:circle,spot:s,idx:i});
});

// ===== ë ˆì´ì–´ í† ê¸€ =====
function togLayer(el){
    var t = el.getAttribute('data-t');
    vis[t] = !vis[t];
    el.classList.toggle('on',vis[t]);
    el.querySelector('.dot').style.background = vis[t]?COL[t]:'#333';
    if(vis[t]) map.addLayer(markerLayers[t]);
    else map.removeLayer(markerLayers[t]);
}

// ===== TOP 10 ë¦¬ìŠ¤íŠ¸ =====
var listEl = document.getElementById('spotList');
SPOTS.slice(0,10).forEach(function(s,i){
    var c = COL[s.t];
    var div = document.createElement('div');
    div.className = 'sitem';
    div.setAttribute('data-idx',i);
    div.innerHTML = '<div class="rk">'+(i+1)+'</div><div class="sn">'+s.n+'</div><div class="st" style="background:'+c+'25;color:'+c+';">'+TN[s.t]+'</div><div class="sc">'+s.sc+'</div>';
    div.onclick = function(){
        map.setView([s.la,s.lo],15);
        markers[i].marker.openPopup();
        document.querySelectorAll('.sitem').forEach(function(el){el.classList.remove('active');});
        div.classList.add('active');
    };
    listEl.appendChild(div);
});

// ===== AI ë¶„ì„ =====
function analyzeSpot(idx){
    var s = SPOTS[idx];
    currentSpotIdx = idx;
    var panel = document.getElementById('aiPanel');
    var content = document.getElementById('aiContent');
    var nameEl = document.getElementById('aiSpotName');
    
    nameEl.textContent = TI[s.t]+' '+s.n;
    panel.classList.add('show');
    
    // ë¡œë”©
    content.innerHTML = '<div class="ai-loading"><div class="spin">ğŸ¤–</div><div class="msg">Claude AI ë¶„ì„ ì¤‘...</div><div class="sub">ê²½ì‚¬ë„Â·ê°•ìˆ˜Â·ì‚¬ê³ Â·ì†ŒìŒ 4ê°œ ë ˆì´ì–´ êµì°¨ ë¶„ì„ + N2B ì ìš©</div></div>';
    
    // API í˜¸ì¶œ
    var prompt = 'ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë„ë¡œí¬ì¥ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë„ë¡œ ì¡°ê±´ì„ ë¶„ì„í•˜ê³ , N2B(Not-But-Because) í”„ë ˆì„ì›Œí¬ë¥¼ ì ìš©í•˜ì—¬ ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”ì„±ì„ íŒì •í•˜ì„¸ìš”.\n\në„ë¡œ ì¡°ê±´:\n- ìœ„ì¹˜: '+s.n+' (ì„œìš¸ì‹œ)\n- ê²½ì‚¬ë„: '+s.sl+'%\n- ì—°ê°„ í­ìš° íšŸìˆ˜ (30mm/hr ì´ìƒ): '+s.rn+'íšŒ\n- ìš°ì²œì‹œ êµí†µì‚¬ê³ : '+s.ac+'ê±´/ë…„\n- ì¼ êµí†µëŸ‰: '+s.tr.toLocaleString()+'ëŒ€\n- ë¶ˆíˆ¬ìˆ˜ë©´ìœ¨: '+s.im+'%\n- 10ë…„ê°„ ì¹¨ìˆ˜ ì´ë ¥: '+s.fl+'íšŒ\n- ì†ŒìŒ ë¯¼ì›: '+s.cm+'ê±´/ë…„\n\në°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. JSON ì™¸ì— ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”:\n{"recommendation":"ë°°ìˆ˜ì„± ë˜ëŠ” ì €ì†ŒìŒ ë˜ëŠ” íˆ¬ìˆ˜ì„±","risk_score":0ì—ì„œ100ì‚¬ì´ìˆ«ì,"urgency":"ê¸´ê¸‰ ë˜ëŠ” ë†’ìŒ ë˜ëŠ” ë³´í†µ ë˜ëŠ” ë‚®ìŒ","key_factors":["ì£¼ìš” ìœ„í—˜ ìš”ì¸ 3ê°œë¥¼ ë°°ì—´ë¡œ"],"n2b":{"n":"ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”ì„± ëª…ì œ","b1":"í˜„ì¬ BPì˜ ê°•ì ","b2":"í˜„ì¬ BPì˜ ë¹ˆí‹ˆ"},"improvement":"ì˜ˆìƒ ê°œì„  íš¨ê³¼ 1ë¬¸ì¥","cost_ì–µ":ì˜ˆìƒë¹„ìš©ìˆ«ì,"roi":íˆ¬ìëŒ€ë¹„íš¨ê³¼ë°°ìˆ˜,"detail":"ìƒì„¸ ë¶„ì„ 3~4ë¬¸ì¥"}';

    fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            model:"claude-sonnet-4-20250514",
            max_tokens:1000,
            messages:[{role:"user",content:prompt}]
        })
    })
    .then(function(resp){return resp.json();})
    .then(function(data){
        var text = '';
        if(data.content){
            data.content.forEach(function(b){if(b.text) text+=b.text;});
        }
        var clean = text.replace(/```json|```/g,'').trim();
        var result = JSON.parse(clean);
        renderAIResult(result,s);
    })
    .catch(function(err){
        content.innerHTML = '<div class="ai-error">AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message+'<br><br>GitHub Pagesì— ë°°í¬ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</div>';
    });
}

function renderAIResult(r,s){
    var c = COL[s.t];
    var recKey = Object.keys(TN).find(function(k){return TN[k]===r.recommendation;});
    var recColor = recKey ? COL[recKey] : '#f0b429';
    var urgColors = {'ê¸´ê¸‰':'#ef4444','ë†’ìŒ':'#f59e0b','ë³´í†µ':'#22c55e','ë‚®ìŒ':'#64748b'};
    
    var h = '';
    
    // íŒì • ê²°ê³¼
    h += '<div class="ai-verdict">';
    h += '<div class="label">AI íŒì • ê²°ê³¼</div>';
    h += '<div class="rec" style="color:'+recColor+'">'+r.recommendation+' í¬ì¥</div>';
    h += '<div class="stats">';
    h += '<div class="stat"><div class="sl">ìœ„í—˜ì ìˆ˜</div><div class="sv" style="color:#f0b429">'+r.risk_score+'</div></div>';
    h += '<div class="stat"><div class="sl">ê¸´ê¸‰ë„</div><div class="sv" style="color:'+(urgColors[r.urgency]||'#888')+'">'+r.urgency+'</div></div>';
    h += '<div class="stat"><div class="sl">ROI</div><div class="sv" style="color:#22c55e">'+r.roi+'ë°°</div></div>';
    h += '</div></div>';
    
    // í•µì‹¬ ìœ„í—˜ ìš”ì¸
    h += '<div class="ai-factors"><div class="title">âš ï¸ í•µì‹¬ ìœ„í—˜ ìš”ì¸</div>';
    if(r.key_factors){
        r.key_factors.forEach(function(f){
            h += '<div class="ai-factor">'+f+'</div>';
        });
    }
    h += '</div>';
    
    // N2B ë¶„ì„
    h += '<div class="ai-n2b">';
    h += '<div class="title">ğŸ”¬ N2B í”„ë ˆì„ì›Œí¬ ë¶„ì„</div>';
    if(r.n2b){
        h += '<div class="line"><span class="ln">N:</span> '+r.n2b.n+'</div>';
        h += '<div class="line"><span class="lb">Bâ‚ (ê°•ì ):</span> <span style="color:#888">'+r.n2b.b1+'</span></div>';
        h += '<div class="line"><span class="lb">Bâ‚‚ (ë¹ˆí‹ˆ):</span> '+r.n2b.b2+'</div>';
    }
    h += '</div>';
    
    // ë¹„ìš© & íš¨ê³¼
    h += '<div class="ai-cost">';
    h += '<div class="ai-cost-card" style="background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);"><div class="cl">ì˜ˆìƒ ë¹„ìš©</div><div class="cv" style="color:#22c55e">'+r.cost_ì–µ+'ì–µ</div></div>';
    h += '<div class="ai-cost-card" style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.2);"><div class="cl">ì˜ˆìƒ íš¨ê³¼</div><div class="ct" style="color:#a855f7">'+r.improvement+'</div></div>';
    h += '</div>';
    
    // ìƒì„¸ ë¶„ì„
    h += '<div class="ai-detail"><div class="dt">ğŸ“‹ ìƒì„¸ ë¶„ì„</div>'+r.detail+'</div>';
    
    // ì¬ë¶„ì„
    h += '<button class="ai-retry" onclick="analyzeSpot('+currentSpotIdx+')">ğŸ”„ ì¬ë¶„ì„</button>';
    
    document.getElementById('aiContent').innerHTML = h;
}

function closeAI(){
    document.getElementById('aiPanel').classList.remove('show');
}

// ì§€ë„ í´ë¦­ ì‹œ AI íŒ¨ë„ ë‹«ê¸°
map.on('click',function(e){
    // ë§ˆì»¤ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ë§Œ
});
</script>
</body>
</html>
