<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”êµ¬ê°„ ìë™ íƒìƒ‰ í”Œë«í¼</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,'Malgun Gothic',sans-serif;background:#0a0a0f;color:#e0e0e0;overflow:hidden;height:100vh;display:flex;flex-direction:column;}
.top{background:#0f0f16;padding:7px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(240,180,41,.3);flex-shrink:0;z-index:2000;}
.top h1{font-size:14px;font-weight:900;color:#f0b429;}
.top .sub{font-size:10px;color:#666;}
.badges{margin-left:auto;display:flex;gap:5px;}
.badge{padding:2px 7px;border-radius:20px;font-size:9px;font-weight:700;transition:all .3s;}
.b-g{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.4);color:#22c55e;}
.b-y{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.4);color:#f59e0b;}
.b-r{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.4);color:#ef4444;}
.b-b{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.4);color:#3b82f6;}
.main{display:flex;flex:1;overflow:hidden;}
.pn{width:270px;flex-shrink:0;background:rgba(12,12,18,.98);border-right:1px solid rgba(255,255,255,.06);overflow-y:auto;padding:10px;z-index:1500;font-size:10px;}
.pn::-webkit-scrollbar{width:3px;}.pn::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px;}
.sec{margin-bottom:10px;}.stt{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:5px;}
.lt{display:flex;align-items:center;gap:5px;padding:5px 7px;margin-bottom:2px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:5px;cursor:pointer;transition:all .15s;}
.lt:hover{background:rgba(255,255,255,.06);}.lt.on{border-color:var(--c);background:var(--bg);}
.lt .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}.lt .nm{font-weight:600;flex:1;font-size:10px;}.lt .ct{font-weight:900;color:var(--c);font-size:10px;}
.rc{padding:8px;margin-bottom:6px;background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.2);border-radius:8px;text-align:center;}
.rc .bi{font-size:28px;font-weight:900;color:#f0b429;}.rc .lb{font-size:9px;color:#666;}
.tgr{display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;margin-bottom:6px;}
.tc{padding:4px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:4px;text-align:center;}
.tc .tn{font-size:10px;font-weight:700;}.tc .tv{font-size:11px;font-weight:900;color:#22c55e;margin-top:2px;}
.ar{display:flex;align-items:center;gap:5px;padding:3px 6px;font-size:9px;}
.ard{width:6px;height:6px;border-radius:50%;flex-shrink:0;}.arn{flex:1;font-weight:600;}.ars{font-size:8px;}
.si{display:flex;align-items:center;gap:5px;padding:4px 6px;margin-bottom:2px;background:rgba(255,255,255,.03);border:1px solid transparent;border-radius:4px;cursor:pointer;transition:all .12s;}
.si:hover{background:rgba(240,180,41,.1);}.si.ac{background:rgba(240,180,41,.15);border-color:rgba(240,180,41,.3);}
.si .rk{width:16px;height:16px;border-radius:50%;background:#f0b429;color:#000;font-size:8px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.si .sn{flex:1;font-weight:600;font-size:10px;}.si .ss{padding:1px 3px;border-radius:3px;font-size:8px;font-weight:700;}.si .sv{font-weight:900;color:#f0b429;font-size:9px;}
.nb{padding:8px;background:rgba(240,180,41,.04);border:1px solid rgba(240,180,41,.12);border-radius:6px;font-size:9px;line-height:1.5;}
/* ì‹¤ì‹œê°„ êµí†µ */
.tf-item{display:flex;align-items:center;gap:5px;padding:3px 6px;margin-bottom:2px;background:rgba(255,255,255,.03);border-radius:4px;font-size:9px;}
.tf-name{flex:1;font-weight:600;}.tf-speed{font-weight:900;min-width:32px;text-align:right;}
.tf-bar{width:40px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;}.tf-bar-in{height:100%;border-radius:2px;}
.mw{flex:1;position:relative;z-index:1;}
#map{width:100%;height:100%;z-index:1;}
.leaflet-popup-content-wrapper{background:rgba(15,15,25,.96)!important;color:#e0e0e0!important;border:1px solid rgba(240,180,41,.35)!important;border-radius:10px!important;box-shadow:0 8px 32px rgba(0,0,0,.6)!important;}
.leaflet-popup-tip{background:rgba(15,15,25,.96)!important;}
.leaflet-popup-content{margin:10px 14px!important;font-family:-apple-system,'Malgun Gothic',sans-serif!important;}
.pt{font-size:14px;font-weight:900;color:#f0b429;margin-bottom:8px;}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:10px;margin-bottom:8px;}
.pr{display:flex;justify-content:space-between;}.pr .k{color:#666;}.pr .v{font-weight:700;}
.pd{font-size:9px;color:#888;line-height:1.4;margin-bottom:10px;}
.pb{width:100%;padding:10px;background:linear-gradient(135deg,#f0b429,#e09000);border:none;border-radius:8px;color:#000;font-weight:900;font-size:11px;cursor:pointer;}.pb:hover{filter:brightness(1.1);}
.ps{font-size:8px;color:#666;text-align:center;margin-top:3px;}
.cm{border-radius:50%;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;transition:transform .2s;}.cm:hover{transform:scale(1.2);}
.map-style-ctrl{position:absolute;top:10px;left:10px;z-index:1500;display:flex;gap:3px;background:rgba(12,12,18,.92);border:1px solid rgba(240,180,41,.3);border-radius:8px;padding:4px;}
.map-style-btn{padding:4px 8px;border:1px solid transparent;border-radius:5px;background:transparent;color:#888;font-size:9px;font-weight:700;cursor:pointer;transition:all .15s;font-family:inherit;}.map-style-btn:hover{color:#e0e0e0;background:rgba(255,255,255,.06);}
.map-style-btn.active{background:rgba(240,180,41,.2);border-color:rgba(240,180,41,.4);color:#f0b429;}
/* ê¸°ìƒ ë¯¸ë‹ˆ íŒ¨ë„ */
.wx-mini{position:absolute;bottom:10px;left:10px;z-index:1500;background:rgba(12,12,18,.92);border:1px solid rgba(59,130,246,.3);border-radius:10px;padding:10px;min-width:180px;display:none;}
.wx-mini.show{display:block;}
.wx-mini .wx-title{font-size:10px;font-weight:700;color:#3b82f6;margin-bottom:6px;}.wx-mini .wx-row{display:flex;justify-content:space-between;font-size:9px;padding:2px 0;}
.wx-mini .wx-val{font-weight:700;color:#e0e0e0;}
/* AI íŒ¨ë„ */
.ap{position:absolute;top:10px;right:10px;width:350px;max-height:calc(100% - 20px);overflow-y:auto;background:rgba(12,12,18,.97);border:1px solid rgba(240,180,41,.4);border-radius:12px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.7);z-index:1500;display:none;}
.ap.show{display:block;}.ap::-webkit-scrollbar{width:3px;}.ap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px;}
.ah{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}.ah h3{font-size:13px;font-weight:900;color:#f0b429;}.ax{cursor:pointer;color:#666;font-size:16px;padding:2px 6px;}.ax:hover{color:#fff;}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.al{text-align:center;padding:30px;}.al .sp{font-size:28px;display:inline-block;animation:spin 1s linear infinite;}.al .mg{font-size:11px;color:#f0b429;font-weight:700;margin-top:8px;}.al .su{font-size:9px;color:#666;margin-top:3px;}
.mt{padding:2px 8px;border-radius:10px;font-size:8px;display:inline-block;}.mt-l{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:#22c55e;}.mt-o{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);color:#f59e0b;}
.av{padding:12px;background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.3);border-radius:8px;margin-bottom:10px;text-align:center;}.av .ll{font-size:9px;color:#888;margin-bottom:2px;}.av .re{font-size:22px;font-weight:900;}.av .vs{display:flex;justify-content:center;gap:14px;margin-top:8px;}.av .vs>div{text-align:center;}.av .sl{font-size:8px;color:#888;}.av .sv2{font-size:15px;font-weight:900;}
.af{margin-bottom:10px;}.af .ti{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:4px;}.af .fi{font-size:9px;padding:4px 8px;margin-bottom:2px;background:rgba(239,68,68,.08);border-left:2px solid #ef4444;border-radius:0 4px 4px 0;color:#ccc;line-height:1.4;}
.an2{padding:10px;background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.15);border-radius:8px;margin-bottom:10px;}.an2 .ti{font-size:10px;font-weight:700;color:#f0b429;margin-bottom:6px;}.an2 .li{font-size:10px;margin-bottom:5px;line-height:1.5;}.an2 .ln{color:#ef4444;font-weight:700;}.an2 .lb2{color:#f0b429;font-weight:700;}
.ac2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}.ac2>div{padding:8px;border-radius:6px;text-align:center;}.ac2 .cl{font-size:8px;color:#888;}.ac2 .cv{font-size:16px;font-weight:900;}.ac2 .ct2{font-size:9px;font-weight:600;margin-top:2px;line-height:1.3;}
.ad2{padding:8px;background:rgba(255,255,255,.03);border-radius:6px;font-size:9px;color:#aaa;line-height:1.6;margin-bottom:10px;}.ad2 .dti{font-size:9px;font-weight:700;color:#888;margin-bottom:4px;}
.art{width:100%;padding:8px;background:rgba(240,180,41,.12);border:1px solid rgba(240,180,41,.3);border-radius:6px;color:#f0b429;font-weight:700;font-size:10px;cursor:pointer;margin-top:4px;}.art:hover{background:rgba(240,180,41,.2);}
.ae{padding:12px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:8px;font-size:10px;color:#ef4444;line-height:1.5;}
@media(max-width:768px){.pn{width:220px;}.ap{width:300px;}}
@media(max-width:480px){.pn{display:none;}.ap{width:calc(100% - 20px);left:10px;right:10px;}}
</style>
</head>
<body>
<div class="top">
    <span style="font-size:18px;">ğŸ›£ï¸</span>
    <div><h1>ê¸°ëŠ¥ì„± í¬ì¥ í•„ìš”êµ¬ê°„ ìë™ íƒìƒ‰ í”Œë«í¼</h1><div class="sub">VWorld ê³µê³µì§€ë„ + Claude AI N2B + ASOSÂ·TAASÂ·TOPIS ì‹¤ì‹œê°„ ì—°ë™</div></div>
    <div class="badges">
        <div class="badge b-y" id="aiBadge">AI í™•ì¸ì¤‘...</div>
        <div class="badge b-b" id="mapBadge">ì§€ë„ ë¡œë”©...</div>
        <div class="badge b-r">v1.1</div>
    </div>
</div>
<div class="main">
<div class="pn">
    <div class="sec">
        <div class="stt">ğŸ“Š í¬ì¥ ìœ í˜• ë ˆì´ì–´</div>
        <div class="lt on" style="--c:#ef4444;--bg:rgba(239,68,68,.06);" data-t="drain" onclick="tog(this)"><div class="dot" style="background:#ef4444;"></div><div class="nm">ğŸ›£ï¸ ë°°ìˆ˜ì„± (ê²½ì‚¬+í­ìš°+ì‚¬ê³ )</div><div class="ct">9</div></div>
        <div class="lt on" style="--c:#a855f7;--bg:rgba(168,85,247,.06);" data-t="quiet" onclick="tog(this)"><div class="dot" style="background:#a855f7;"></div><div class="nm">ğŸ”‡ ì €ì†ŒìŒ (ì£¼ê±°+êµí†µëŸ‰)</div><div class="ct">8</div></div>
        <div class="lt on" style="--c:#06b6d4;--bg:rgba(6,182,212,.06);" data-t="perm" onclick="tog(this)"><div class="dot" style="background:#06b6d4;"></div><div class="nm">ğŸ’§ íˆ¬ìˆ˜ì„± (ì¹¨ìˆ˜+ë¶ˆíˆ¬ìˆ˜ë©´)</div><div class="ct">6</div></div>
        <div class="lt on" style="--c:#facc15;--bg:rgba(250,204,21,.06);" data-t="cctv" onclick="togCCTV(this)"><div class="dot" style="background:#facc15;"></div><div class="nm">ğŸ“¹ ITS CCTV ì˜ìƒ</div><div class="ct" id="cctvCnt">0</div></div>
        <div class="lt on" style="--c:#fb923c;--bg:rgba(251,146,60,.06);" data-t="safety" onclick="togSafety(this)"><div class="dot" style="background:#fb923c;"></div><div class="nm">ğŸ”§ ë„ë¡œì•ˆì „ì‹œì„¤ ì ê²€</div><div class="ct" id="safetyCnt">0</div></div>
    </div>
    <div class="sec">
        <div class="stt">ğŸ¯ ì¢…í•© ë¶„ì„</div>
        <div class="rc"><div class="bi">23</div><div class="lb">ê¸°ëŠ¥ì„± í¬ì¥ ì¶”ì²œ êµ¬ê°„</div></div>
        <div class="tgr">
            <div class="tc"><div class="tn" style="color:#ef4444;">ë°°ìˆ˜ì„±</div><div class="tv">9ê³³</div></div>
            <div class="tc"><div class="tn" style="color:#a855f7;">ì €ì†ŒìŒ</div><div class="tv">8ê³³</div></div>
            <div class="tc"><div class="tn" style="color:#06b6d4;">íˆ¬ìˆ˜ì„±</div><div class="tv">6ê³³</div></div>
        </div>
    </div>
    <div class="sec">
        <div class="stt">ğŸš¦ ì‹¤ì‹œê°„ êµí†µ ì†Œí†µ</div>
        <div id="trafficPanel"><div style="color:#666;font-size:9px;padding:4px;">ë¡œë”© ì¤‘...</div></div>
    </div>
    <div class="sec">
        <div class="stt">ğŸ“¡ API ì—°ë™ ìƒíƒœ</div>
        <div class="ar"><div class="ard" id="d-ai" style="background:#f59e0b;"></div><div class="arn">Claude AI ë¶„ì„</div><div class="ars" id="s-ai" style="color:#f59e0b;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-vw" style="background:#f59e0b;"></div><div class="arn">VWorld ê³µê³µì§€ë„</div><div class="ars" id="s-vw" style="color:#f59e0b;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-wx" style="background:#666;"></div><div class="arn">ê¸°ìƒì²­ ASOS</div><div class="ars" id="s-wx" style="color:#666;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-ta" style="background:#666;"></div><div class="arn">TAAS ì‚¬ê³ ì´ë ¥</div><div class="ars" id="s-ta" style="color:#666;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-tp" style="background:#666;"></div><div class="arn">TOPIS êµí†µ</div><div class="ars" id="s-tp" style="color:#666;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-cc" style="background:#666;"></div><div class="arn">ITS CCTV ì˜ìƒ</div><div class="ars" id="s-cc" style="color:#666;">í™•ì¸ì¤‘</div></div>
        <div class="ar"><div class="ard" id="d-sf" style="background:#fb923c;"></div><div class="arn">ì•ˆì „ì‹œì„¤ ì ê²€</div><div class="ars" id="s-sf" style="color:#fb923c;">ìƒ˜í”Œ</div></div>
    </div>
    <div class="sec">
        <div class="stt">ğŸ† ìš°ì„ ìˆœìœ„ TOP 10</div>
        <div id="list"></div>
    </div>
    <div class="sec">
        <div class="nb">
            <div style="color:#ef4444;font-weight:700;">N: "ì„œìš¸ì‹œ ì „ì²´ ë„ë¡œì— ê¸°ëŠ¥ì„± í¬ì¥"</div>
            <div style="color:#f0b429;font-weight:700;">B: ì „ë¶€ëŠ” ì•„ë‹ˆì§€ë§Œ</div>
            <div style="color:#f0b429;font-weight:700;">B: ê²½ì‚¬3%+âˆ©í­ìš°âˆ©ì‚¬ê³  â†’ <b>23ê³³</b>ì—” í•„ìš”!</div>
            <div style="color:#555;margin-top:3px;">â†’ ì „ì²´ 2.3%ë§Œ êµì²´ â†’ ì‚¬ê³  30%â†“<br>23ê³³Ã—2kmÃ—3ì²œë§Œ = <b style="color:#f0b429;">ì•½ 138ì–µì›</b></div>
        </div>
    </div>
</div>
<div class="mw">
    <div id="map"></div>
    <div class="map-style-ctrl" id="mapStyleCtrl" style="display:none;">
        <button class="map-style-btn active" onclick="switchMap('base',this)">ğŸ—ºï¸ ê¸°ë³¸</button>
        <button class="map-style-btn" onclick="switchMap('satellite',this)">ğŸ›°ï¸ ìœ„ì„±</button>
        <button class="map-style-btn" onclick="switchMap('hybrid',this)">ğŸ™ï¸ í•˜ì´ë¸Œë¦¬ë“œ</button>
        <button class="map-style-btn" onclick="switchMap('midnight',this)">ğŸŒ™ ë‹¤í¬</button>
        <button class="map-style-btn" onclick="switchMap('white',this)">â˜€ï¸ ë°ì€</button>
    </div>
    <div class="wx-mini" id="wxPanel">
        <div class="wx-title">ğŸŒ§ï¸ ì„œìš¸ ì‹¤ì‹œê°„ ê¸°ìƒ (ASOS)</div>
        <div id="wxData"><div style="font-size:9px;color:#666;">ë¡œë”© ì¤‘...</div></div>
    </div>
    <div class="ap" id="aiP">
        <div class="ah"><h3>ğŸ¤– AI ì¢…í•© ë¶„ì„</h3><span class="ax" onclick="closeAI()">âœ•</span></div>
        <div id="aiN" style="font-size:11px;font-weight:700;color:#ccc;margin-bottom:8px;"></div>
        <div id="aiC"></div>
    </div>
</div>
</div>

<script>
var COL={drain:'#ef4444',quiet:'#a855f7',perm:'#06b6d4'},TN={drain:'ë°°ìˆ˜ì„±',quiet:'ì €ì†ŒìŒ',perm:'íˆ¬ìˆ˜ì„±'},TI={drain:'ğŸ›£ï¸',quiet:'ğŸ”‡',perm:'ğŸ’§'};
var vis={drain:1,quiet:1,perm:1},AI_MODE='checking';
var API_BASE=location.hostname.includes('github.io')?'https://pavement-platform-1.onrender.com':'';

var D=[
{id:1,n:'ë‚¨ì‚° ìˆœí™˜ë¡œ',la:37.5512,lo:126.9882,t:'drain',sl:6.2,rn:42,ac:8,sc:95,tr:35000,im:60,fl:1,cm:3,ds:'ê¸‰ê²½ì‚¬ 6.2% + ì—° 42íšŒ í­ìš° + ìš°ì²œì‚¬ê³  8ê±´/ë…„'},
{id:2,n:'ê°•ë‚¨ì—­ ì¼ëŒ€',la:37.4979,lo:127.0276,t:'perm',sl:1.2,rn:38,ac:3,sc:94,tr:72000,im:92,fl:5,cm:8,ds:'ë¶ˆíˆ¬ìˆ˜ë©´ 92% + ì¹¨ìˆ˜ 5íšŒ/10ë…„'},
{id:3,n:'ì˜¬ë¦¼í”½ëŒ€ë¡œ ì ì‹¤',la:37.518,lo:127.075,t:'quiet',sl:0.8,rn:35,ac:4,sc:92,tr:85000,im:75,fl:2,cm:23,ds:'ì¼ 8.5ë§ŒëŒ€ + ì ì‹¤ì•„íŒŒíŠ¸ ì¸ì ‘'},
{id:4,n:'ë¶ì•…ìŠ¤ì¹´ì´ì›¨ì´',la:37.593,lo:126.967,t:'drain',sl:8.1,rn:38,ac:5,sc:91,tr:12000,im:30,fl:0,cm:1,ds:'ê¸‰ê²½ì‚¬ 8.1% + ì»¤ë¸Œ ì—°ì†'},
{id:5,n:'ì‹ ë¦¼ì—­ ì¼ëŒ€',la:37.484,lo:126.929,t:'perm',sl:2.1,rn:40,ac:4,sc:88,tr:45000,im:85,fl:6,cm:5,ds:'ê´€ì•…ì‚° ìœ ìˆ˜ + ì¹¨ìˆ˜ ë°˜ë³µ'},
{id:6,n:'ì¸ì™•ì‚°í„°ë„ ì§„ì…',la:37.581,lo:126.958,t:'drain',sl:5.4,rn:40,ac:6,sc:88,tr:28000,im:45,fl:1,cm:2,ds:'í„°ë„ ì§„ì¶œì… ê²½ì‚¬ + ë…¸ë©´ ì˜¨ë„ì°¨'},
{id:7,n:'ë‚´ë¶€ìˆœí™˜ ì •ë¦‰',la:37.605,lo:127.008,t:'quiet',sl:1.5,rn:33,ac:3,sc:87,tr:62000,im:70,fl:1,cm:18,ds:'ì£¼ê±°ë°€ì§‘ + ì•¼ê°„ í™”ë¬¼ì°¨ ì†ŒìŒ'},
{id:8,n:'ë™ì‘ëŒ€êµ ë‚¨ë‹¨ ë¨í”„',la:37.505,lo:126.982,t:'drain',sl:4.8,rn:44,ac:7,sc:86,tr:55000,im:65,fl:2,cm:4,ds:'êµëŸ‰ ì ‘ì†ë¶€ ê²½ì‚¬ + ìˆ˜ë§‰'},
{id:9,n:'í•œë‚¨ëŒ€êµ ë¶ë‹¨ IC',la:37.534,lo:127.001,t:'drain',sl:4.2,rn:41,ac:9,sc:85,tr:68000,im:60,fl:1,cm:5,ds:'IC ë¨í”„ + í•©ë¥˜ë¶€ ì‚¬ê³  ë‹¤ë°œ'},
{id:10,n:'ì‚¬ë‹¹ì—­ ì¼ëŒ€',la:37.477,lo:126.982,t:'perm',sl:1.8,rn:39,ac:3,sc:85,tr:48000,im:88,fl:4,cm:6,ds:'ì €ì§€ëŒ€ + ë¶ˆíˆ¬ìˆ˜ë©´ 88%'},
{id:11,n:'ê°•ë³€ë¶ë¡œ ì„±ìˆ˜',la:37.542,lo:127.044,t:'quiet',sl:0.5,rn:34,ac:3,sc:84,tr:78000,im:72,fl:2,cm:15,ds:'ì„±ìˆ˜ë™ ì£¼ê±° ì¸ì ‘'},
{id:12,n:'ìš°ë©´ì‚°í„°ë„ ì ‘ì†ë¶€',la:37.475,lo:126.989,t:'drain',sl:4.5,rn:43,ac:6,sc:83,tr:42000,im:55,fl:3,cm:3,ds:'í„°ë„ + 2011 ì‚°ì‚¬íƒœ ì´ë ¥'},
{id:13,n:'ê´‘í™”ë¬¸ ì¼ëŒ€',la:37.572,lo:126.977,t:'perm',sl:0.5,rn:36,ac:2,sc:82,tr:25000,im:95,fl:3,cm:4,ds:'ë¶ˆíˆ¬ìˆ˜ë©´ 95% + ë³´í–‰ê³µê°„'},
{id:14,n:'ê°•ë‚¨ëŒ€ë¡œ ì—­ì‚¼',la:37.501,lo:127.037,t:'quiet',sl:1.0,rn:37,ac:4,sc:82,tr:72000,im:80,fl:2,cm:20,ds:'ìƒì—…+ì£¼ê±° ì•¼ê°„ì†ŒìŒ'},
{id:15,n:'ì–‘ì¬ëŒ€ë¡œ ì„œì´ˆ',la:37.483,lo:127.024,t:'quiet',sl:1.3,rn:36,ac:3,sc:81,tr:68000,im:78,fl:1,cm:16,ds:'ì„œì´ˆ ì£¼ê±° + ëŒ€í˜•ì°¨ëŸ‰'},
{id:16,n:'ì„±ì‚°ëŒ€êµ ë‚¨ë‹¨',la:37.548,lo:126.912,t:'drain',sl:3.8,rn:39,ac:5,sc:80,tr:52000,im:60,fl:1,cm:4,ds:'êµëŸ‰ ì ‘ì† ê²½ì‚¬'},
{id:17,n:'ë™ë¶€ê°„ì„  ì¥í•œí‰',la:37.562,lo:127.065,t:'quiet',sl:0.8,rn:32,ac:2,sc:79,tr:55000,im:68,fl:1,cm:12,ds:'ì•„íŒŒíŠ¸ + í„°ë„ ì†ŒìŒ'},
{id:18,n:'ê´€ì•…ì‚° ì„œìš¸ëŒ€ì…êµ¬',la:37.464,lo:126.952,t:'drain',sl:7.5,rn:36,ac:4,sc:78,tr:18000,im:40,fl:2,cm:2,ds:'ì‚°ì§€ 7.5% + ë°°ìˆ˜ ë¶ˆëŸ‰'},
{id:19,n:'ë„ë¦¼ì²œ ì£¼ë³€ ë³´ë„',la:37.495,lo:126.903,t:'perm',sl:0.8,rn:38,ac:1,sc:77,tr:15000,im:80,fl:4,cm:3,ds:'í•˜ì²œë³€ ì¹¨ìˆ˜ ì·¨ì•½'},
{id:20,n:'ì„œë¶€ê°„ì„  ì‹ ê¸¸',la:37.508,lo:126.915,t:'quiet',sl:0.6,rn:35,ac:3,sc:76,tr:48000,im:72,fl:1,cm:14,ds:'ì£¼ê±°ë°€ì§‘ + í™”ë¬¼ì°¨'},
{id:21,n:'ëŒ€ëª¨ì‚° ì§„ì…ë¡œ',la:37.482,lo:127.065,t:'drain',sl:5.8,rn:35,ac:3,sc:74,tr:8000,im:25,fl:0,cm:1,ds:'ì‚°ì§€ ê²½ì‚¬ + ë‚™ì—½'},
{id:22,n:'ë¶ë¶€ê°„ì„  ì›”ê³„',la:37.625,lo:127.052,t:'quiet',sl:0.7,rn:31,ac:2,sc:73,tr:45000,im:65,fl:1,cm:11,ds:'ì•„íŒŒíŠ¸ ì˜† ê³ ê°€ë„ë¡œ'},
{id:23,n:'ì¤‘ë‘ì²œ ë³€ ë³´ë„',la:37.575,lo:127.048,t:'perm',sl:0.4,rn:33,ac:1,sc:72,tr:12000,im:78,fl:3,cm:2,ds:'í•˜ì²œë³€ ì›”ë¥˜ ì´ë ¥'}
];
D.sort(function(a,b){return b.sc-a.sc;});

// ===== ì§€ë„ =====
var map=L.map('map',{zoomControl:false}).setView([37.5665,126.978],12);
L.control.zoom({position:'topright'}).addTo(map);
var fallbackTile=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM',subdomains:'abcd',maxZoom:19}).addTo(map);
var vwTiles={},currentTile=null;

function loadVWorldTiles(){
    fetch(API_BASE+'/api/vworld/tile-info').then(function(r){return r.json();}).then(function(d){
        if(d.status==='live'){
            vwTiles=d;if(fallbackTile){map.removeLayer(fallbackTile);fallbackTile=null;}
            currentTile=L.tileLayer(d.base,{attribution:'&copy; VWorld',maxZoom:19,minZoom:5}).addTo(map);
            document.getElementById('mapStyleCtrl').style.display='flex';
            setDot('vw','live');var mb=document.getElementById('mapBadge');mb.className='badge b-g';mb.textContent='VWorld ì§€ë„';
        }else{setDot('vw','off');var mb=document.getElementById('mapBadge');mb.className='badge b-y';mb.textContent='OSM í´ë°±';}
    }).catch(function(){setDot('vw','off');var mb=document.getElementById('mapBadge');mb.className='badge b-y';mb.textContent='OSM í´ë°±';});
}
function switchMap(style,btn){
    if(!vwTiles[style])return;if(currentTile)map.removeLayer(currentTile);if(fallbackTile){map.removeLayer(fallbackTile);fallbackTile=null;}
    currentTile=L.tileLayer(vwTiles[style],{attribution:'&copy; VWorld',maxZoom:19,minZoom:5}).addTo(map);
    document.querySelectorAll('.map-style-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');
}

// ===== ìƒíƒœ í™•ì¸ =====
function checkStatus(){
    fetch(API_BASE+'/api/status').then(function(r){return r.json();}).then(function(d){
        setDot('ai',d.claude_ai==='connected'?'live':'off');
        setDot('wx',d.weather==='connected'?'live':(d.weather==='sample'?'sample':'off'));
        setDot('ta',d.taas==='connected'?'live':(d.taas==='sample'?'sample':'off'));
        setDot('tp',d.topis==='connected'?'live':(d.topis==='sample'?'sample':'off'));
        setDot('cc',d.cctv==='connected'?'live':(d.cctv==='sample'?'sample':'off'));
        AI_MODE=d.claude_ai==='connected'?'live':'offline';
        var b=document.getElementById('aiBadge');
        if(AI_MODE==='live'){b.className='badge b-g';b.textContent='AI ì‹¤ì‹œê°„';}else{b.className='badge b-y';b.textContent='AI ì˜¤í”„ë¼ì¸';}
        loadVWorldTiles();loadCCTV();loadSafety();loadWeather();loadTraffic();
    }).catch(function(){
        AI_MODE='offline';setDot('ai','off');setDot('vw','off');setDot('wx','off');setDot('ta','off');setDot('tp','off');setDot('cc','off');
        var b=document.getElementById('aiBadge');b.className='badge b-y';b.textContent='AI ì˜¤í”„ë¼ì¸';
        var mb=document.getElementById('mapBadge');mb.className='badge b-y';mb.textContent='OSM í´ë°±';
        loadCCTV();loadSafety();
    });
}
function setDot(id,st){
    var d=document.getElementById('d-'+id),s=document.getElementById('s-'+id);if(!d||!s)return;
    if(st==='live'){d.style.background='#22c55e';s.style.color='#22c55e';s.textContent='ì‹¤ì‹œê°„';}
    else if(st==='sample'){d.style.background='#f59e0b';s.style.color='#f59e0b';s.textContent='ìƒ˜í”Œ';}
    else{d.style.background='#666';s.style.color='#666';s.textContent='ë¯¸ì—°ê²°';}
}
setTimeout(checkStatus,500);

// ===== ì‹¤ì‹œê°„ ê¸°ìƒ =====
function loadWeather(){
    fetch(API_BASE+'/api/weather/108').then(function(r){return r.json();}).then(function(d){
        var wp=document.getElementById('wxPanel'),wd=document.getElementById('wxData');
        if(d.status==='live'&&d.data&&d.data.length>0){
            var last=d.data[d.data.length-1];
            wd.innerHTML='<div class="wx-row"><span>ê¸°ì˜¨</span><span class="wx-val">'+last.temp+'Â°C</span></div>'
                +'<div class="wx-row"><span>ê°•ìˆ˜ëŸ‰</span><span class="wx-val">'+(parseFloat(last.rain)||0)+' mm</span></div>'
                +'<div class="wx-row"><span>ìŠµë„</span><span class="wx-val">'+last.humidity+'%</span></div>'
                +'<div class="wx-row"><span>í’ì†</span><span class="wx-val">'+last.wind_speed+' m/s</span></div>'
                +'<div style="font-size:8px;color:#555;margin-top:4px;">ê´€ì¸¡: '+last.time+'</div>';
            wp.classList.add('show');
        }else if(d.status==='sample'){
            wd.innerHTML='<div style="font-size:9px;color:#f59e0b;">ìƒ˜í”Œ ë°ì´í„° (í‚¤ ë°œê¸‰ í›„ ì‹¤ì‹œê°„ ì „í™˜)</div>';
            wp.classList.add('show');
        }
    }).catch(function(){});
}

// ===== ì‹¤ì‹œê°„ êµí†µ =====
function loadTraffic(){
    fetch(API_BASE+'/api/traffic/realtime?start_idx=1&end_idx=20').then(function(r){return r.json();}).then(function(d){
        var tp=document.getElementById('trafficPanel');
        var items=d.data||[];
        if(items.length===0){tp.innerHTML='<div style="color:#666;font-size:9px;padding:4px;">ë°ì´í„° ì—†ìŒ</div>';return;}
        var h='';
        // 23ê°œ êµ¬ê°„ ê´€ë ¨ ë„ë¡œë§Œ í•„í„°
        var roads=['ë‚¨ì‚°','ì˜¬ë¦¼í”½','ê°•ë‚¨','ë‚´ë¶€ìˆœí™˜','ê°•ë³€','ë™ì‘','í•œë‚¨','ì‚¬ë‹¹','ì„œë¶€ê°„ì„ ','ë¶ë¶€ê°„ì„ '];
        var shown=0;
        items.forEach(function(t){
            if(shown>=8)return;
            var match=roads.some(function(r){return t.road_name&&t.road_name.indexOf(r)!==-1;});
            if(!match&&shown>=5)return;
            var spd=parseFloat(t.speed)||0;
            var col=spd>=40?'#22c55e':spd>=20?'#f59e0b':'#ef4444';
            var st=spd>=40?'ì›í™œ':spd>=20?'ì„œí–‰':'ì •ì²´';
            h+='<div class="tf-item"><span class="tf-name">'+t.road_name+'</span>';
            h+='<div class="tf-bar"><div class="tf-bar-in" style="width:'+Math.min(100,spd*1.5)+'%;background:'+col+';"></div></div>';
            h+='<span class="tf-speed" style="color:'+col+'">'+spd+'km</span></div>';
            shown++;
        });
        if(!h)h='<div style="color:#666;font-size:9px;padding:4px;">ê´€ë ¨ ë„ë¡œ ë°ì´í„° ì—†ìŒ</div>';
        tp.innerHTML=h;
    }).catch(function(){
        document.getElementById('trafficPanel').innerHTML='<div style="color:#666;font-size:9px;padding:4px;">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>';
    });
}

// ===== ë§ˆì»¤ =====
var ML={drain:L.layerGroup().addTo(map),quiet:L.layerGroup().addTo(map),perm:L.layerGroup().addTo(map)};var MK=[];
D.forEach(function(s,i){
    var c=COL[s.t],sz=s.sc>=90?30:s.sc>=80?24:18;
    var ic=L.divIcon({className:'',html:'<div class="cm" style="width:'+sz+'px;height:'+sz+'px;background:'+c+';font-size:'+(sz>24?12:sz>18?10:8)+'px;">'+(i<10?(i+1):'')+'</div>',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
    var h='<div class="pt">'+TI[s.t]+' '+s.n+'</div><div class="pg">';
    h+='<div class="pr"><span class="k">ì¶”ì²œí¬ì¥</span><span class="v" style="color:'+c+'">'+TN[s.t]+'</span></div>';
    h+='<div class="pr"><span class="k">ìœ„í—˜ì ìˆ˜</span><span class="v" style="color:#f0b429">'+s.sc+'/100</span></div>';
    h+='<div class="pr"><span class="k">ê²½ì‚¬ë„</span><span class="v">'+s.sl+'%</span></div>';
    h+='<div class="pr"><span class="k">ì—°í­ìš°</span><span class="v">'+s.rn+'íšŒ</span></div>';
    h+='<div class="pr"><span class="k">ìš°ì²œì‚¬ê³ </span><span class="v" style="color:#ef4444">'+s.ac+'ê±´/ë…„</span></div>';
    h+='<div class="pr"><span class="k">êµí†µëŸ‰</span><span class="v">'+(s.tr/10000).toFixed(1)+'ë§ŒëŒ€</span></div>';
    h+='<div class="pr"><span class="k">ë¶ˆíˆ¬ìˆ˜ë©´</span><span class="v">'+s.im+'%</span></div>';
    h+='<div class="pr"><span class="k">ì¹¨ìˆ˜ì´ë ¥</span><span class="v">'+s.fl+'íšŒ/10ë…„</span></div></div>';
    h+='<div class="pd">'+s.ds+'</div>';
    h+='<button class="pb" onclick="analyze('+i+')">ğŸ¤– AI N2B ì¢…í•© ë¶„ì„</button>';
    var mk=L.marker([s.la,s.lo],{icon:ic}).bindPopup(h,{maxWidth:260,minWidth:220});
    var cr=L.circle([s.la,s.lo],{radius:s.sc>=90?400:s.sc>=80?300:200,color:c,fillColor:c,fillOpacity:.06,weight:1,opacity:.2});
    ML[s.t].addLayer(mk);ML[s.t].addLayer(cr);MK.push({m:mk,c:cr,s:s,i:i});
});
function tog(el){var t=el.getAttribute('data-t');vis[t]=vis[t]?0:1;el.classList.toggle('on',!!vis[t]);el.querySelector('.dot').style.background=vis[t]?COL[t]:'#333';if(vis[t])map.addLayer(ML[t]);else map.removeLayer(ML[t]);}

var li=document.getElementById('list');
D.slice(0,10).forEach(function(s,i){
    var c=COL[s.t],d=document.createElement('div');d.className='si';
    d.innerHTML='<div class="rk">'+(i+1)+'</div><div class="sn">'+s.n+'</div><div class="ss" style="background:'+c+'25;color:'+c+';">'+TN[s.t]+'</div><div class="sv">'+s.sc+'</div>';
    d.onclick=function(){map.setView([s.la,s.lo],15);MK[i].m.openPopup();document.querySelectorAll('.si').forEach(function(e){e.classList.remove('ac');});d.classList.add('ac');};
    li.appendChild(d);
});

// ===== AI ë¶„ì„ =====
var curIdx=null;
function analyze(idx){var s=D[idx];curIdx=idx;var p=document.getElementById('aiP');document.getElementById('aiN').textContent=TI[s.t]+' '+s.n;p.classList.add('show');map.closePopup();
    document.getElementById('aiC').innerHTML='<div class="al"><div class="sp">ğŸ¤–</div><div class="mg">N2B ë¶„ì„ ì¤‘...</div></div>';
    setTimeout(function(){renderResult(offlineAI(s),s);},600);}
function deepAnalyze(idx){if(AI_MODE!=='live'){alert('AI ì‹¬í™” ë¶„ì„ì€ ë°±ì—”ë“œ ì—°ê²° ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');return;}
    var s=D[idx],box=document.getElementById('deepBox');box.innerHTML='<div class="al"><div class="sp">ğŸ¤–</div><div class="mg">Claude AI ì‹¬í™” ë¶„ì„ ì¤‘...</div></div>';
    var base=offlineAI(s);
    var prompt='ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë„ë¡œí¬ì¥ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\nêµ¬ê°„: '+s.n+' (ì„œìš¸ì‹œ)\nì¶”ì²œ: '+base.recommendation+' í¬ì¥, ìœ„í—˜ì ìˆ˜: '+base.risk_score+'/100\nê²½ì‚¬ë„: '+s.sl+'%, í­ìš°: '+s.rn+'íšŒ/ë…„, ì‚¬ê³ : '+s.ac+'ê±´/ë…„\nêµí†µëŸ‰: '+s.tr+'ëŒ€/ì¼, ë¶ˆíˆ¬ìˆ˜ë©´: '+s.im+'%\n\nì‹¬í™” ë¶„ì„ì„ JSONìœ¼ë¡œ:\n{"alternatives":[{"name":"ëŒ€ì•ˆëª…","pros":"ì¥ì ","cons":"ë‹¨ì "}],"phasing":"ì‹œê³µì „ëµ","maintenance":"ìœ ì§€ë³´ìˆ˜","similar_cases":"ìœ ì‚¬ì‚¬ë¡€","budget_note":"ì˜ˆì‚°ì „ëµ"}';
    fetch(API_BASE+'/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})})
    .then(function(r){return r.json();}).then(function(d){
        if(d.error)throw new Error(d.error);var text='';if(d.content)d.content.forEach(function(b){if(b.text)text+=b.text;});
        var r=JSON.parse(text.replace(/```json|```/g,'').trim());
        var h='<div style="text-align:center;margin-bottom:6px;"><span class="mt mt-l">ğŸŸ¢ Claude AI ì‹¬í™” ë¶„ì„ ì™„ë£Œ</span></div>';
        if(r.alternatives)r.alternatives.forEach(function(a){h+='<div style="padding:4px 8px;margin-bottom:3px;background:rgba(168,85,247,.06);border-left:2px solid #a855f7;border-radius:0 4px 4px 0;font-size:9px;line-height:1.5;"><b>'+a.name+'</b><br><span style="color:#22c55e;">âœ“ '+a.pros+'</span><br><span style="color:#ef4444;">âœ— '+a.cons+'</span></div>';});
        if(r.phasing)h+='<div style="margin-top:6px;font-size:9px;color:#aaa;line-height:1.5;">ğŸ“… '+r.phasing+'</div>';
        if(r.maintenance)h+='<div style="font-size:9px;color:#aaa;line-height:1.5;">ğŸ”§ '+r.maintenance+'</div>';
        if(r.similar_cases)h+='<div style="font-size:9px;color:#aaa;line-height:1.5;">ğŸŒ '+r.similar_cases+'</div>';
        box.innerHTML=h;
    }).catch(function(err){box.innerHTML='<div class="ae">âš ï¸ '+err.message+'</div>';});
}
function offlineAI(s){
    var factors={drain:['ê²½ì‚¬ë„ '+s.sl+'%ë¡œ ìˆ˜ë§‰ ì„ê³„ì¹˜ '+(s.sl/3).toFixed(1)+'ë°° ì´ˆê³¼','ì—° '+s.rn+'íšŒ ì§‘ì¤‘í˜¸ìš° ì‹œ ë°°ìˆ˜ ë¶ˆëŸ‰','ìš°ì²œ ì‚¬ê³  '+s.ac+'ê±´/ë…„'],
        quiet:['ì¼ '+(s.tr/10000).toFixed(1)+'ë§ŒëŒ€ ê³ ì†ŒìŒ','ì†ŒìŒ ë¯¼ì› '+s.cm+'ê±´/ë…„','ì•¼ê°„ ì €ì£¼íŒŒ ì†ŒìŒ'],
        perm:['ë¶ˆíˆ¬ìˆ˜ë©´ '+s.im+'%','10ë…„ ì¹¨ìˆ˜ '+s.fl+'íšŒ','ìš°ìˆ˜ ì¹¨íˆ¬ ë¶ˆê°€']};
    var n2bs={drain:{n:s.n+' ë°°ìˆ˜ì„± í¬ì¥ ì‹œê¸‰',b1:'í˜„í–‰ PMSê°€ ë¬¼ë¦¬ì  ì†ìƒì„ íƒì§€í•˜ê³  ìˆìŒ',b2:'ê²½ì‚¬ë„Â·ê°•ìˆ˜Â·ì‚¬ê³  3ë ˆì´ì–´ êµì°¨ ë¶„ì„ ì‹œìŠ¤í…œ ë¶€ì¬'},
        quiet:{n:s.n+' ì €ì†ŒìŒ í¬ì¥ í•„ìš”',b1:'ë°©ìŒë²½ì´ ì¤‘Â·ê³ ì£¼íŒŒ ì†ŒìŒì„ ê°ì†Œì‹œí‚¤ê³  ìˆìŒ',b2:'ë°œìƒì›(íƒ€ì´ì–´-ë…¸ë©´) ìì²´ë¥¼ ì¤„ì´ëŠ” í¬ì¥ ì „í™˜ ë¯¸ì‹œí–‰'},
        perm:{n:s.n+' íˆ¬ìˆ˜ì„± í¬ì¥ í•„ìš”',b1:'í•˜ìˆ˜ë„Â·íŒí”„ì¥ì´ ì¼ë°˜ ê°•ìˆ˜ì— ëŒ€ì‘',b2:'ê·¹í•œ ê°•ìˆ˜ ì‹œ ë¶ˆíˆ¬ìˆ˜ë©´ '+s.im+'%ê°€ ìœ ì¶œëŸ‰ ê°ë‹¹ ë¶ˆê°€'}};
    var cost=s.t==='drain'?Math.round(s.sc*.08*10)/10:s.t==='quiet'?Math.round(s.sc*.06*10)/10:Math.round(s.sc*.04*10)/10;
    var roi=Math.max(2,Math.min(8,s.t==='drain'?Math.round(s.ac*1.2*10)/10:s.t==='quiet'?Math.round(s.cm*.3*10)/10:Math.round(s.fl*2.5*10)/10));
    var urg=s.sc>=90?'ê¸´ê¸‰':s.sc>=80?'ë†’ìŒ':'ë³´í†µ';
    var imp=s.t==='drain'?'ìš°ì²œ ì‚¬ê³  ì•½ '+Math.round(s.ac*.35)+'ê±´ ê°ì†Œ':s.t==='quiet'?'ì†ŒìŒ 3~8dB ì €ê°, ë¯¼ì› 60% ê°ì†Œ':'ì¹¨ìˆ˜ í”¼í•´ '+Math.round(s.fl*.6)+'íšŒ ê°ì†Œ';
    return {recommendation:TN[s.t],risk_score:s.sc,urgency:urg,key_factors:factors[s.t],n2b:n2bs[s.t],improvement:imp,cost_ì–µ:cost,roi:roi};
}
function renderResult(r,s){
    var c=COL[s.t],uc={'ê¸´ê¸‰':'#ef4444','ë†’ìŒ':'#f59e0b','ë³´í†µ':'#22c55e'};
    var h='<div style="text-align:center;margin-bottom:8px;"><span class="mt mt-o">ğŸ“Š N2B ë¶„ì„</span></div>';
    h+='<div class="av"><div class="ll">íŒì •</div><div class="re" style="color:'+c+'">'+r.recommendation+' í¬ì¥</div>';
    h+='<div class="vs"><div><div class="sl">ìœ„í—˜</div><div class="sv2" style="color:#f0b429">'+r.risk_score+'</div></div>';
    h+='<div><div class="sl">ê¸´ê¸‰ë„</div><div class="sv2" style="color:'+(uc[r.urgency]||'#888')+'">'+r.urgency+'</div></div>';
    h+='<div><div class="sl">ROI</div><div class="sv2" style="color:#22c55e">'+r.roi+'ë°°</div></div></div></div>';
    h+='<div class="af"><div class="ti">âš ï¸ ìœ„í—˜ ìš”ì¸</div>';r.key_factors.forEach(function(f){h+='<div class="fi">'+f+'</div>';});h+='</div>';
    h+='<div class="an2"><div class="ti">ğŸ”¬ N2B ë¶„ì„</div>';
    h+='<div class="li"><span class="ln">N:</span> '+r.n2b.n+'</div>';
    h+='<div class="li"><span class="lb2">Bâ‚:</span> <span style="color:#888">'+r.n2b.b1+'</span></div>';
    h+='<div class="li"><span class="lb2">Bâ‚‚:</span> '+r.n2b.b2+'</div></div>';
    h+='<div class="ac2"><div style="background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);"><div class="cl">ë¹„ìš©</div><div class="cv" style="color:#22c55e">'+r.cost_ì–µ+'ì–µ</div></div>';
    h+='<div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.2);"><div class="cl">íš¨ê³¼</div><div class="ct2" style="color:#a855f7">'+r.improvement+'</div></div></div>';
    if(AI_MODE==='live')h+='<button class="art" style="background:rgba(168,85,247,.15);border-color:rgba(168,85,247,.4);color:#a855f7;" onclick="deepAnalyze('+curIdx+')">ğŸ¤– AI ì‹¬í™” ë¶„ì„</button>';
    else h+='<button class="art" style="opacity:.5;cursor:default;">ğŸ¤– AI ì‹¬í™” (ë°±ì—”ë“œ ì—°ê²° ì‹œ)</button>';
    h+='<div id="deepBox" style="margin-top:8px;"></div>';
    document.getElementById('aiC').innerHTML=h;
}
function closeAI(){document.getElementById('aiP').classList.remove('show');}

// ===== CCTV =====
var cctvLayer=L.layerGroup().addTo(map),cctvVisible=true;
var ITS_CCTV_KEY='5fa7b53b001d4b34b733fd9129ceb7a6';
function loadCCTV(){
    // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ITS API í˜¸ì¶œ
    var url='https://openapi.its.go.kr:9443/cctvInfo?apiKey='+ITS_CCTV_KEY+'&type=ex&cctvType=1&minX=126.8&maxX=127.2&minY=37.4&maxY=37.7&getType=json';
    fetch(url).then(function(r){return r.json();}).then(function(d){
        console.log('ITS CCTV data:', d);
        cctvLayer.clearLayers();
        if(d.response && d.response.data && d.response.data.length>0){
            var items=d.response.data.slice(0,30); // ìµœëŒ€ 30ê°œ
            document.getElementById('cctvCnt').textContent=items.length;
            items.forEach(function(c){
                var lat=parseFloat(c.coordy),lng=parseFloat(c.coordx);
                if(!lat||!lng)return;
                var ic=L.divIcon({className:'',html:'<div style="width:14px;height:14px;background:#facc15;border:2px solid #fff;border-radius:3px;box-shadow:0 2px 6px rgba(0,0,0,.5);font-size:8px;display:flex;align-items:center;justify-content:center;">ğŸ“¹</div>',iconSize:[14,14],iconAnchor:[7,7]});
                var videoHtml='';
                if(c.cctvurl){
                    videoHtml='<div style="margin-top:8px;"><img src="'+c.cctvurl+'" style="width:100%;max-width:280px;border-radius:6px;border:1px solid #333;" onerror="this.style.display=\'none\';this.nextSibling.style.display=\'block\'"/><div style="display:none;font-size:9px;color:#f59e0b;padding:8px;background:rgba(245,158,11,.1);border-radius:4px;">âš ï¸ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨ (CORS ì œí•œ)</div></div>';
                }
                var popup='<div style="font-size:12px;font-weight:900;color:#facc15;margin-bottom:4px;">ğŸ“¹ '+(c.cctvname||'CCTV')+'</div><div style="font-size:9px;color:#888;">'+lat.toFixed(4)+', '+lng.toFixed(4)+'</div>'+videoHtml;
                cctvLayer.addLayer(L.marker([lat,lng],{icon:ic}).bindPopup(popup,{maxWidth:320,minWidth:200}));
            });
            console.log('CCTV markers added:', items.length);
        }else{
            loadCCTVSample();
        }
    }).catch(function(e){
        console.error('ITS API error:',e);
        loadCCTVSample();
    });
}
function loadCCTVSample(){
    var samples=[
        {name:'ë‚¨ì‚°1í„°ë„ ì…êµ¬',lat:37.553,lng:126.985},{name:'ê°•ë‚¨ì—­ êµì°¨ë¡œ',lat:37.498,lng:127.028},
        {name:'ì˜¬ë¦¼í”½ëŒ€ë¡œ ì ì‹¤ëŒ€êµ',lat:37.519,lng:127.078},{name:'ë¶ì•…í„°ë„ ì…êµ¬',lat:37.591,lng:126.968},
        {name:'ì‹ ë¦¼ì‚¬ê±°ë¦¬',lat:37.485,lng:126.93},{name:'ì¸ì™•ì‚°í„°ë„',lat:37.58,lng:126.959},
        {name:'ë‚´ë¶€ìˆœí™˜ ì •ë¦‰ì…êµ¬',lat:37.604,lng:127.01},{name:'ë™ì‘ëŒ€êµ ë‚¨ë‹¨',lat:37.506,lng:126.983},
        {name:'í•œë‚¨IC',lat:37.535,lng:127.002},{name:'ì‚¬ë‹¹ì—­',lat:37.478,lng:126.983}
    ];
    document.getElementById('cctvCnt').textContent=samples.length;
    samples.forEach(function(c){
        var ic=L.divIcon({className:'',html:'<div style="width:14px;height:14px;background:#facc15;border:2px solid #fff;border-radius:3px;box-shadow:0 2px 6px rgba(0,0,0,.5);font-size:8px;display:flex;align-items:center;justify-content:center;">ğŸ“¹</div>',iconSize:[14,14],iconAnchor:[7,7]});
        var popup='<div style="font-size:12px;font-weight:900;color:#facc15;margin-bottom:4px;">ğŸ“¹ '+c.name+'</div><div style="font-size:9px;color:#888;">'+c.lat.toFixed(4)+', '+c.lng.toFixed(4)+'</div><div style="font-size:9px;color:#666;margin-top:4px;">ìƒ˜í”Œ ë°ì´í„°</div>';
        cctvLayer.addLayer(L.marker([c.lat,c.lng],{icon:ic}).bindPopup(popup,{maxWidth:200}));
    });
}
function togCCTV(el){cctvVisible=!cctvVisible;el.classList.toggle('on',cctvVisible);el.querySelector('.dot').style.background=cctvVisible?'#facc15':'#333';if(cctvVisible)map.addLayer(cctvLayer);else map.removeLayer(cctvLayer);}

// ===== ì•ˆì „ì‹œì„¤ =====
var safetyLayer=L.layerGroup().addTo(map),safetyVisible=true;
var SC={'ì–‘í˜¸':'#22c55e','ì£¼ì˜':'#f59e0b','êµì²´í•„ìš”':'#ef4444'};
function loadSafety(){
    fetch(API_BASE+'/api/safety-facilities?lat=37.5665&lng=126.978&radius=0.15').then(function(r){return r.json();}).then(function(d){
        var items=d.data||[];document.getElementById('safetyCnt').textContent=items.length;
        items.forEach(function(f){
            var sc=SC[f.status]||'#888';
            var ic=L.divIcon({className:'',html:'<div style="width:14px;height:14px;background:'+sc+';border:2px solid #fff;border-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,.4);font-size:8px;display:flex;align-items:center;justify-content:center;">ğŸ”§</div>',iconSize:[14,14],iconAnchor:[7,7]});
            var popup='<div style="font-size:12px;font-weight:900;color:#fb923c;margin-bottom:4px;">ğŸ”§ '+f.name+'</div><div style="font-size:9px;"><b style="color:'+sc+'">'+f.status+'</b> ('+f.grade+'ë“±ê¸‰) Â· ì ê²€: '+f.last_check+'</div><div style="font-size:9px;color:#aaa;margin-top:4px;">'+f.issue+'</div>';
            safetyLayer.addLayer(L.marker([f.lat,f.lng],{icon:ic}).bindPopup(popup,{maxWidth:220}));
        });
    }).catch(function(){document.getElementById('safetyCnt').textContent='â€“';});
}
function togSafety(el){safetyVisible=!safetyVisible;el.classList.toggle('on',safetyVisible);el.querySelector('.dot').style.background=safetyVisible?'#fb923c':'#333';if(safetyVisible)map.addLayer(safetyLayer);else map.removeLayer(safetyLayer);}
</script>
</body>
</html>
